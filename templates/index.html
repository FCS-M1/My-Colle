<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>自己紹介メーカー</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="{{ url_for('static', filename='style.css') }}" rel="stylesheet">
</head>
<body>
  <div class="container mt-5">
    <!-- ステップバー -->
    <div class="mb-4">
      <h5 id="step-label">ステップ 1 / 3</h5>
      <div class="progress">
        <div id="progress-bar" class="progress-bar" style="width: 33%;"></div>
      </div>
    </div>

    <!-- ステップ1: 質問入力 -->
    <div id="step1" class="fade-in">
      <h4>自己紹介で使いたい質問を入力してください（1つ以上）</h4>
      <form id="initial-question-form" autocomplete="off">
        <div id="question-inputs">
          <input class="form-control my-2" name="question1" required placeholder="質問 1">
        </div>
        <div class="d-flex justify-content-between mt-2">
          <button type="button" class="btn btn-outline-secondary" id="add-question-btn">＋ 質問を追加</button>
          <button class="btn btn-primary">次へ</button>
        </div>
      </form>
    </div>

    <!-- ステップ2: 回答入力 -->
    <div id="step2" class="hidden fade-in">
      <h4>質問に答えてください</h4>
      <form id="answer-form"></form>
      <div id="slider-section" class="mt-4">
        <label for="extra-count" class="form-label">追加質問の数（2〜10）</label>
        <input type="range" class="form-range" id="extra-count" min="2" max="10" value="3" step="1">
        <div>選択中: <span id="extra-count-value">3</span> 問</div>
      </div>
    </div>

    <!-- スピナー（質問生成中） -->
    <div id="loading-spinner" class="d-none text-center my-4">
      <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Loading...</span>
      </div>
      <p>追加の質問を生成中...</p>
    </div>

    <!-- ステップ3: 追加質問に答える + スタイル指定 + 生成 -->
    <div id="step3" class="hidden fade-in">
      <h4>さらに深掘りして答えてください</h4>
      <form id="extra-answer-form"></form>
    </div>

    <!-- スピナー（自己紹介生成中） -->
    <div id="intro-loading-spinner" class="d-none text-center my-4">
      <div class="spinner-border text-success" role="status">
        <span class="visually-hidden">Loading...</span>
      </div>
      <p>自己紹介を生成中...</p>
    </div>

    <!-- ステップ4: 結果 -->
    <div id="result" class="hidden fade-in">
      <h4>あなたの自己紹介文</h4>
      <div class="card p-4 my-3 shadow-sm">
        <p id="intro-text"></p>
        <div class="text-end">
          <button id="copy-btn" class="btn btn-outline-secondary btn-sm">コピーする</button>
        </div>
      </div>
      <button id="restart-btn" class="btn btn-secondary">最初に戻る</button>
    </div>
  </div>

  <script>
    let questions = [];
    let answers = [];
    let questionCount = 1;
    
    document.getElementById("add-question-btn").addEventListener("click", () => {
      questionCount++;
      const div = document.createElement("div");
      div.innerHTML = `<input class="form-control my-2" name="question${questionCount}" required placeholder="質問 ${questionCount}">`;
      document.getElementById("question-inputs").appendChild(div);
    });

    window.addEventListener("DOMContentLoaded", setupInitialFormSubmit);

    function setupInitialFormSubmit() {
      document.getElementById("initial-question-form").addEventListener("submit", async (e) => {
        e.preventDefault();
        const formData = new FormData(e.target);
        questions = Array.from(formData.values()).filter(q => q.trim());
        updateProgress(2);

        const form = document.getElementById("answer-form");
        form.innerHTML = "";
        questions.forEach(q => {
          form.innerHTML += `<label>${q}</label><input name="${q}" class="form-control my-2" required>`;
        });
        form.innerHTML += `<button class="btn btn-success mt-3">次へ</button>`;

        toggleSteps("step1", "step2");
      });
    }

    // ステップ2 → ステップ3
    document.getElementById("answer-form").addEventListener("submit", async (e) => {
      e.preventDefault();
      let answers = {};
      const formData = new FormData(e.target);
      formData.forEach((v, k) => answers[k] = v);
      const extraCount = parseInt(document.getElementById("extra-count").value);

      document.getElementById("loading-spinner").classList.remove("d-none");

      const res = await fetch("/generate_extra_questions", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ answers, extra_count: extraCount })
      });
      const data = await res.json();
      document.getElementById("loading-spinner").classList.add("d-none");

      const form = document.getElementById("extra-answer-form");
      form.innerHTML = "";
      data.extra_questions.forEach(q => {
        form.innerHTML += `<label>${q}</label><input name="${q}" class="form-control my-2" required>`;
      });
      form.innerHTML += `
        <div class="mt-4">
          <h5>どのようなスタイルの自己紹介にしますか？</h5>
          <input id="style-choice" class="form-control mt-2" placeholder="例: 関西弁でおもしろく / 小泉構文風に など">
        </div>
        <div class="text-center">
          <button class="btn btn-info mt-4">自己紹介を生成</button>
        </div>
      `;

      updateProgress(3);
      toggleSteps("step2", "step3");
    });

    // ステップ3 → 結果
    document.getElementById("extra-answer-form").addEventListener("submit", async (e) => {
      e.preventDefault();
    
      let answers = {};
      const formData = new FormData(e.target);
      formData.forEach((v, k) => answers[k] = v);
      const style = document.getElementById("style-choice").value.trim();

      document.getElementById("intro-loading-spinner").classList.remove("d-none");

      const res = await fetch("/generate_intro", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ answers, style })
      });
      const data = await res.json();
      document.getElementById("intro-loading-spinner").classList.add("d-none");

      toggleSteps("step3", "result");
      document.getElementById("intro-text").innerText = data.introduction;
    });

    // コピー機能
    document.getElementById("copy-btn").addEventListener("click", () => {
      const text = document.getElementById("intro-text").innerText;
      navigator.clipboard.writeText(text).then(() => {
        const btn = document.getElementById("copy-btn");
        const original = btn.innerText;
        btn.innerText = "コピーしました！";
        btn.disabled = true;
        setTimeout(() => {
          btn.innerText = original;
          btn.disabled = false;
        }, 1500);
      }).catch(() => alert("コピーに失敗しました。"));
    });

    // 最初に戻る
    document.getElementById("restart-btn").addEventListener("click", () => {
      questions = [];
      answers = {};
      questionCount = 1;
      document.getElementById("question-inputs").innerHTML = `
        <input class="form-control my-2" name="question1" required placeholder="質問 1">
      `;
      document.getElementById("answer-form").innerHTML = "";
      document.getElementById("extra-answer-form").innerHTML = "";
      document.getElementById("intro-text").innerText = "";
      document.getElementById("loading-spinner").classList.add("d-none");
      document.getElementById("intro-loading-spinner").classList.add("d-none");
      updateProgress(1);
      toggleSteps("result", "step1");
      setupInitialFormSubmit();
    });

    function toggleSteps(hideId, showId) {
      document.getElementById(hideId).classList.add("hidden");
      document.getElementById(showId).classList.remove("hidden");
    }

    function updateProgress(step) {
      const bar = document.getElementById("progress-bar");
      const label = document.getElementById("step-label");
      const percent = step === 1 ? 33 : step === 2 ? 66 : 100;
      bar.style.width = `${percent}%`;
      label.textContent = `ステップ ${step} / 3`;
    }

    document.addEventListener("input", (e) => {
      if (e.target.id === "extra-count") {
        document.getElementById("extra-count-value").innerText = e.target.value;
      }
    });
  </script>
</body>
</html>
