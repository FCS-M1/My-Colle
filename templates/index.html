<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>自己紹介メーカー</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="{{ url_for('static', filename='style.css') }}" rel="stylesheet">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Kaisei+Decol&display=swap" rel="stylesheet">
</head>
<body>
  <h1> 自己紹介ジェネレータ </h1>
  <h3> AIを使って自己紹介を作ってもらおう! </h3>

  <div class="container mt-5">

    <!-- ステップバー -->
    <div class="mb-4">
      <h5 id="step-label">ステップ 1 / 4</h5>
      <div class="progress">
        <div id="progress-bar" class="progress-bar" style="width: 33%;"></div>
      </div>
    </div>

    <!-- ステップ1: 初期質問入力 -->
    <div id="step1" class="fade-in">
      <h4>自己紹介で使いたい質問を入力してください</h4>
      <form id="initial-question-form" autocomplete="off">
        <input class="form-control my-2" name="question1" required placeholder="質問 1"><br>
        <input class="form-control my-2" name="question2" required placeholder="質問 2"><br>
        <input class="form-control my-2" name="question3" required placeholder="質問 3"><br>
        <button class="btn btn-primary mt-3">次へ</button>
      </form>
    </div>

    <!-- ステップ2: 回答入力 -->
    <div id="step2" class="hidden fade-in">
      <h4>質問に答えてください</h4>
      <form id="answer-form"></form>
    </div>

    <!-- スピナー表示（追加質問生成中） -->
    <div id="loading-spinner" class="d-none text-center my-4">
      <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Loading...</span>
      </div>
      <p>🤖 追加の質問を生成中...</p>
    </div>

    <!-- ステップ3: 追加質問回答 -->
    <div id="step3" class="hidden fade-in">
      <h4>さらに深掘りして答えてください</h4>
      <form id="extra-answer-form">
        <!-- JSで質問が動的に挿入される -->
      </form>

    </div>


    <!-- スピナー表示（自己紹介生成中） -->
    <div id="intro-loading-spinner" class="d-none text-center my-4">
      <div class="spinner-border text-success" role="status">
        <span class="visually-hidden">Loading...</span>
      </div>
      <p>🤖 自己紹介を生成中...</p>
    </div>

    <!-- ステップ4: 結果表示 -->
    <div id="result" class="hidden fade-in">
      <h4>あなたの自己紹介文</h4>
      <div class="card p-4 my-3 shadow-sm">
        <p id="intro-text"></p>
      </div>
      <button id="copy-btn" class="btn btn-outline-primary mt-2">コピーする</button>
      <p id="copy-status" class="text-success small mt-1" style="display: none;">コピーしました！</p>

      <button id="restart-btn" class="btn btn-secondary">最初に戻る</button>
    </div>

  </div>

  <script>
    let questions = [];
    let answers = {};

    function setupInitialFormSubmit() {
      document.getElementById("initial-question-form").addEventListener("submit", async (e) => {
        e.preventDefault();
        const formData = new FormData(e.target);
        questions = Array.from(formData.values()).filter(q => q.trim());
        updateProgress(2);

        const form = document.getElementById("answer-form");
        form.innerHTML = "";
        questions.forEach(q => {
          form.innerHTML += `<label>${q}</label><input name="${q}" class="form-control my-2" required>`;
        });
        form.innerHTML += `<button class="btn btn-success mt-3">次へ</button>`;

        toggleSteps("step1", "step2");
      });
    }

    // ステップ1 → ステップ2
    document.getElementById("initial-question-form").addEventListener("submit", async (e) => {
      e.preventDefault();
      const formData = new FormData(e.target);
      questions = Array.from(formData.values()).filter(q => q.trim());
      updateProgress(2);

      const form = document.getElementById("answer-form");
      form.innerHTML = "";
      questions.forEach(q => {
        form.innerHTML += `<label>${q}</label><input name="${q}" class="form-control my-2" required>`;
      });
      form.innerHTML += `<button class="btn btn-success mt-3">次へ</button>`;

      toggleSteps("step1", "step2");
    });

    // ステップ2 → ステップ3
    document.getElementById("answer-form").addEventListener("submit", async (e) => {
      e.preventDefault();
      const formData = new FormData(e.target);
      formData.forEach((v, k) => answers[k] = v);

      document.getElementById("loading-spinner").classList.remove("d-none");

      const res = await fetch("/generate_extra_questions", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ answers })
      });
      const data = await res.json();

      document.getElementById("loading-spinner").classList.add("d-none");

      const form = document.getElementById("extra-answer-form");
      form.innerHTML = "";
      data.extra_questions.forEach(q => {
        form.innerHTML += `<label>${q}</label><input name="${q}" class="form-control my-2" required>`;
      });

      form.innerHTML += `
      <div class="mt-4">
        <h5>どのようなスタイルの自己紹介にしますか？</h5>
        <input id="style-choice" class="form-control mt-2" placeholder="例: 関西弁でおもしろく / 小泉構文風に など">
      </div>
      <button class="btn btn-info mt-3">自己紹介を生成</button>
    `;


      updateProgress(3);
      toggleSteps("step2", "step3");
    });


    // ステップ3 → 結果表示
    document.getElementById("extra-answer-form").addEventListener("submit", async (e) => {
      e.preventDefault();
      const formData = new FormData(e.target);
      formData.forEach((v, k) => answers[k] = v);

      const style = document.getElementById("style-choice").value.trim();
      document.getElementById("intro-loading-spinner").classList.remove("d-none");

      const res = await fetch("/generate_intro", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ answers, style })
      });

      const data = await res.json();
      document.getElementById("intro-loading-spinner").classList.add("d-none");

      toggleSteps("step3", "result");
      updateProgress(4);
      document.getElementById("intro-text").innerText = data.introduction;

    });

    // 最初に戻る
    document.getElementById("restart-btn").addEventListener("click", () => {
      questions = [];
      answers = {};
      document.getElementById("initial-question-form").innerHTML = `
        <input class="form-control my-2" name="question1" required placeholder="質問 1"><br>
        <input class="form-control my-2" name="question2" required placeholder="質問 2"><br>
        <input class="form-control my-2" name="question3" required placeholder="質問 3"><br>
        <button class="btn btn-primary mt-3">次へ</button>
      `;

      document.getElementById("answer-form").innerHTML = "";
      document.getElementById("extra-answer-form").innerHTML = "";
      document.getElementById("style-choice")?.remove(); // 安全に削除
      document.getElementById("intro-text").innerText = "";
      document.getElementById("loading-spinner").classList.add("d-none");
      document.getElementById("intro-loading-spinner").classList.add("d-none");
      updateProgress(1);
      toggleSteps("result", "step1");

      // ✅ submit イベント再登録
      setupInitialFormSubmit();
    });


    function toggleSteps(hideId, showId) {
      document.getElementById(hideId).classList.add("hidden");
      document.getElementById(showId).classList.remove("hidden");
    }

    function updateProgress(step) {
      const bar = document.getElementById("progress-bar");
      const label = document.getElementById("step-label");
      const percent = step === 1 ? 25 : step === 2 ? 50 : step === 3 ? 75 : 100;
      bar.style.width = `${percent}%`;
      label.textContent = `ステップ ${step} / 4`;
    }

    document.getElementById("copy-btn").addEventListener("click", () => {
      const text = document.getElementById("intro-text").innerText;
      navigator.clipboard.writeText(text).then(() => {
        const status = document.getElementById("copy-status");
        status.style.display = "block";
        setTimeout(() => status.style.display = "none", 2000);
      });
    });

  </script>
</body>
</html>
